define(["sandbox"],function(i){function k(){a&&(a.hide(),a.find("#zebra-toolbar").addClass("hidden"),a.find("#zebra-expand-button").removeClass("mirrored"))}var a,f,m={start:function(){this.assignEventHandlers()},assignEventHandlers:function(){var d=this;if(f){a.children("div").not("div input").disableTextSelect();jQuery(f.svg.root()).delegate("g.group","mousedown.dizzy.zebra.scale",function(a){return d.translateStart(this,a)});var b=a.find("#zebra-rotate");b.bind("mousedown.dizzy.zebra.rotate",function(a){return d.rotateStart(b,
a)});var c=a.find("#zebra-scale");c.bind("mousedown.dizzy.zebra.scale",function(a){return d.scaleStart(c,a)});a.find("#zebra-translate").bind("mousedown.dizzy.zebra.translate",function(a){var b=j.dom();return d.translateStart(b,a)});a.find("#zebra-expand-button").bind("click.dizzy.zebra.expand",function(){$("#zebra-toolbar").toggleClass("hidden");$(this).toggleClass("mirrored")});a.find("#zebra-toolbar-up").bind("click.dizzy.zebra.toolbar.up",d.raiseLayer);a.find("#zebra-toolbar-down").bind("click.dizzy.zebra.toolbar.down",
d.lowerLayer);a.find("#zebra-toolbar-downest").bind("click.dizzy.zebra.toolbar.downest",d.lowerLayerMax);a.find("#zebra-toolbar-uppest").bind("click.dizzy.zebra.toolbar.uppest",d.raiseLayerMax);a.find("#zebra-toolbar-border-weight-up").bind("click.dizzy.zebra.toolbar.strokeWidth.up",d.raiseStrokeWidth);a.find("#zebra-toolbar-border-weight-down").bind("click.dizzy.zebra.toolbar.strokeWidth.down",d.lowerStrokeWidth);a.find("#zebra-toolbar-43").bind("click.dizzy.zebra.toolbar.43",function(){return d.fitRectTo(4,
3)});a.find("#zebra-toolbar-169").bind("click.dizzy.zebra.toolbar.169",function(){return d.fitRectTo(16,9)});a.find("#zebra-toolbar-1610").bind("click.dizzy.zebra.toolbar.1610",function(){return d.fitRectTo(16,10)});a.find("#zebra-toolbar-fill").bind("click.dizzy.zebra.toolbar.fill",function(){return d.raiseFillOpacity(0.2)});a.find("#zebra-toolbar-nofill").bind("click.dizzy.zebra.toolbar.nofill",function(){return d.raiseFillOpacity(-0.2)});a.find("#zebra-toolbar-border-round").bind("click.dizzy.zebra.toolbar.round",
d.roundCorners)}},removeEventHandlers:function(){f&&jQuery(f.svg.root()).undelegate("g.group","mousedown.dizzy.zebra.scale");a.find("#zebra-rotate").unbind("mousedown.dizzy.zebra.rotate");a.find("#zebra-scale").unbind("mousedown.dizzy.zebra.scale");a.find("#zebra-translate").unbind("mousedown.dizzy.zebra.translate");a.find("#zebra-expand-button").unbind("click.dizzy.zebra.expand");a.find("#zebra-toolbar-up").unbind("click.dizzy.zebra.toolbar.up");a.find("#zebra-toolbar-down").unbind("click.dizzy.zebra.toolbar.down");
a.find("#zebra-toolbar-uppest").unbind("click.dizzy.zebra.toolbar.uppest");a.find("#zebra-toolbar-downest").unbind("click.dizzy.zebra.toolbar.downest");a.find("#zebra-toolbar-border-weight-up").unbind("click.dizzy.zebra.toolbar.strokeWidth.up");a.find("#zebra-toolbar-border-weight-down").unbind("click.dizzy.zebra.toolbar.strokeWidth.down");a.find("#zebra-toolbar-43").unbind("click.dizzy.zebra.toolbar.43");a.find("#zebra-toolbar-169").unbind("click.dizzy.zebra.toolbar.169");a.find("#zebra-toolbar-1610").unbind("click.dizzy.zebra.toolbar.1610");
a.find("#zebra-toolbar-fill").unbind("click.dizzy.zebra.toolbar.fill");a.find("#zebra-toolbar-nofill").unbind("click.dizzy.zebra.toolbar.nofill");a.find("#zebra-toolbar-border-round").unbind("click.dizzy.zebra.toolbar.round")},rotateStart:function(d,b){b.preventDefault();if(j!==void 0){var c=a.offset(),c={x:c.left+a.outerWidth()/2,y:c.top+a.outerHeight()/2},e={origin:c,lastVector:{x:b.pageX-c.x,y:b.pageY-c.y}},g=e.lastRotationAngle,h=j.transformation();$(document).bind("mousemove.dizzy.zebra.rotate",
function(a){a.preventDefault();var b={x:a.pageX-e.origin.x,y:a.pageY-e.origin.y},a=180/Math.PI*(Math.atan2(b.y,b.x)-Math.atan2(e.lastVector.y,e.lastVector.x)),a=Math.floor(a*360)/360;e.lastVector=b;var b=f.toCanvasCoordinates(e.origin),c=h.matrix();h=h.multiply(c.inverse()).rotate(a,b.x,b.y).multiply(c);g=(a+g)%360;a=["","-o-","-webkit-","-moz-","-ms-"];for(b=0;b<a.length;++b)d.css(a[b]+"transform","rotate("+g+"deg)");f.transform(j,h,{duration:0});i.publish("dizzy.ui.zebra.start.rotate")});$(document).bind("mouseup.dizzy.zebra.rotate mouseleave.dizzy.zebra.rotate",
function(){$(document).unbind("mousemove.dizzy.zebra.rotate")})}return!1},scaleStart:function(d,b){b.preventDefault();b.stopPropagation();if(j!==void 0){var c=a.offset(),e={origin:{x:c.left+a.outerWidth()/2,y:c.top+a.outerHeight()/2}},g=j.transformation(),c={x:e.origin.x-b.pageX,y:e.origin.y-b.pageY},h=Math.sqrt(c.x*c.x+c.y*c.y),l=1;$(document).bind("mousemove.dizzy.zebra.scale",function(a){a.preventDefault();var a={x:e.origin.x-a.pageX,y:e.origin.y-a.pageY},d=Math.sqrt(a.x*a.x+a.y*a.y)/h,a=d-l;l=
d;var d=f.toCanvasCoordinates(e.origin),b=g.matrix();g=g.multiply(b.inverse()).translate(-d.x*a,-d.y*a).scale(a+1).multiply(b);f.transform(j,g,{duration:0});i.publish("dizzy.ui.zebra.start.scale")});$(document).bind("mouseup.dizzy.zebra.scale mouseleave.dizzy.zebra.scale",function(){$(document).unbind("mousemove.dizzy.zebra.scale");$(document).unbind("mouseup.dizzy.zebra.scale mouseleave.dizzy.zebra.scale")})}return!1},translateStart:function(d,b){d.jquery&&d.size()>0&&(d=d[0]);b.preventDefault();
var c=f.findGroup(d);i.publish("dizzy.presentation.group.selected",{event:b,group:c});var e=function(a){return f.vectorTranslate(a,{ignoreCanvas:!1,targetNode:d})},g={x:b.pageX,y:b.pageY},g=e(g),h=c.transformation();$(document).bind("mousemove.dizzy.zebra.translate",function(d){d.preventDefault();var b={x:d.pageX,y:d.pageY},b=e(b);h=h.translate(b.x-g.x,b.y-g.y);f.transform(c,h,{duration:0});a.css({top:d.pageY-a.height()/2,left:d.pageX-a.width()/2});i.publish("dizzy.ui.zebra.start.translate")});$(document).bind("mouseup.dizzy.zebra.translate mouseleave.dizzy.zebra.translate",
function(){$(document).unbind("mousemove.dizzy.zebra.translate");$(document).unbind("mouseup.dizzy.zebra.translate mouseleave.dizzy.zebra.translate")});return!1},stop:function(){this.removeEventHandlers();a.hide()},lowerLayer:function(){var a=$(".selected",f.svg.root());a.hasClass("group")||(a=a.parents("g.group").first());a.insertBefore(a.prev("g.group"))},raiseLayer:function(){var a=$(".selected",f.svg.root());a.hasClass("group")||(a=a.parents("g.group").first());a.insertAfter(a.next("g.group"))},
lowerLayerMax:function(){var a=$(".selected",f.svg.root());a.hasClass("group")||(a=a.parents("g.group").first());a.prependTo("#canvas")},raiseLayerMax:function(){var a=$(".selected",f.svg.root());a.hasClass("group")||(a=a.parents("g.group").first());a.appendTo("#canvas")},lowerStrokeWidth:function(){var a=$(".selected",f.svg.root());$children=a.children();$children.length==1&&(a=$children.first());var b=a.attr("stroke-width"),b=isNaN(b)?3:parseFloat(b);b>0&&(b>1?a.attr("stroke-width",b-2):a.attr("stroke-width",
Math.round(b*10-1)/10))},raiseStrokeWidth:function(){var a=$(".selected",f.svg.root());$children=a.children();$children.length==1&&(a=$children.first());var b=a.attr("stroke-width"),b=isNaN(b)?3:parseFloat(b);b>=1?a.attr("stroke-width",b+2):a.attr("stroke-width",Math.round(b*10+1)/10)},fitRectTo:function(a,b){var c=$(".selected",f.svg.root());$children=c.children();$children.length==1&&(c=$children.first());var e=c.attr("width"),g=c.attr("height"),h=e/g,i=a/b;h>i?(e=e/a*b,c.attr("height",e),h=c.attr("y"),
c.attr("y",h-(e-g)/2)):h<i&&(g=g/b*a,c.attr("width",g),h=c.attr("x"),c.attr("x",h-(g-e)/2))},raiseFillOpacity:function(a){var b=$(".selected",f.svg.root());$children=b.children();$children.length==1&&(b=$children.first());var c=parseFloat(b.attr("fill-opacity"));isNaN(c)&&(c=1);c+=a;c<0?c=0:c>1&&(c=1);b.attr("fill-opacity",Math.round(c*10)/10)},roundCorners:function(){var a=$(".selected",f.svg.root());$children=a.children();$children.length==1&&(a=$children.first());var b=a.attr("rx"),c=Math.round(Math.min(a.attr("width"),
a.attr("height"))/10),b=!b||isNaN(b)||b==0?c:b==c?Math.round(Math.min(a.attr("width"),a.attr("height"))/4):0;a.attr("rx",b)}};i.subscribe("dizzy.presentation.loaded",function(a){f=a.canvas});i.subscribe("dizzy.presentation.transform",k);i.subscribe("dizzy.ui.resizer.start",k);var j;i.subscribe("dizzy.presentation.group.selected",function(d){if(a){var b=d.event;j=d.group;a.css({top:b.pageY-a.height()/2,left:b.pageX-a.width()/2});a.hide();a.show();a.find(".toolbutton").removeClass("hidden");d=j.dom().children().first();
if((b=d.prop("localName"))&&b!="rect"){if(a.find("#zebra-toolbar-43").addClass("hidden"),a.find("#zebra-toolbar-169").addClass("hidden"),a.find("#zebra-toolbar-1610").addClass("hidden"),a.find("#zebra-toolbar-border-round").addClass("hidden"),b=="image"||b=="line")b=="image"&&(a.find("#zebra-toolbar-border-weight-up").addClass("hidden"),a.find("#zebra-toolbar-border-weight-down").addClass("hidden")),a.find("#zebra-toolbar-fill").addClass("hidden"),a.find("#zebra-toolbar-nofill").addClass("hidden")}else d.hasClass("invisibleRect")&&
(a.find("#zebra-toolbar-border-round").addClass("hidden"),a.find("#zebra-toolbar-border-weight-up").addClass("hidden"),a.find("#zebra-toolbar-border-weight-down").addClass("hidden"),a.find("#zebra-toolbar-fill").addClass("hidden"),a.find("#zebra-toolbar-nofill").addClass("hidden"))}});return{init:function(){var d=$("#container");$.get("html/zebra.html").success(function(b){a=$(b);d.prepend(a);a.hide();i.publish("dizzy.ui.zebra.loaded")}).error(function(a){console.error("Could not load zebra control: "+
a)}).complete(function(){i.publish("dizzy.modes.register",{name:"zebra",instance:m})})},destroy:function(){a&&a.remove()}}});
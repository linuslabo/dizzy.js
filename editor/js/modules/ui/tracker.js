define(["sandbox"],function(g){var e,f,d,m=0,h=[];g.subscribe("dizzy.presentation.loaded",function(b){e=b.canvas;if(f==void 0)n();else{m=0;for(d.html("<tr><th>Type</th><th>Name</th><th>Path Num</th><th>Zoom</th><th>Speed</th><th>Go</th></tr>");0<h.length;)h.pop();k()}});g.subscribe("dizzy.canvas.group.created",function(b){var a="",c=b.group.dom(),b=c.attr("id"),c=c.children().prop("localName"),e="img/"+c+".png";h.push({type:c,id:b});if(c=="line"||c=="g"||c==void 0)a='class="hidden"',e="";d.append("<tr "+
a+'><td><img src="'+e+'" /></td><td><input class="tracker-name" type="text" size="7" value="'+ ++m+'"/></td><td><input class="tracker-path-numbers" type="text" size="7"/></td><td><input class="tracker-zoom" type="text" size="2" value="100"/></td><td><input class="tracker-speed" type="text" size="1" value="1"/></td><td class="tracker-go"><img src="./img/tracker_go.png"/></td></tr>')});g.subscribe("dizzy.canvas.group.removed",function(b){for(var b=b.id,a=0;a<h.length;a++)if(b==h[a].id){d.find("tr:nth-child("+
(a+2)+")").remove();h.splice(a,1);break}});g.subscribe("dizzy.canvas.group.text.edited",function(b){var a=b.textGroup.dom(),b=a.children().first().children("tspan").first().text().replace(/ /g,"").substring(0,6);a.attr("name",b);for(var a=a.attr("id"),c=0;c<h.length;c++)if(a==h[c].id){d.find("tr:nth-child("+(c+2)+")").find(".tracker-name").val(b);break}});var k=function(){if(e)for(var b=0;b<e.groupList.length;b++){var a=e.groupList[b].dom(),c=a.attr("id"),g="",o=a.attr("name")?a.attr("name"):++m,
f=a.children().prop("localName"),k="img/"+f+".png";if(f=="line"||f=="g"||f==void 0)g='class="hidden"',k="";else{var l=/group_(\d+)/gi,i=a.attr("class");i!=void 0&&(i=i.match(l));l="";if(i!=null)for(var j=0;j<i.length;j++)l+=i[j].substring(6)+" ";i=(i=a.attr("zoom"))?i:100;j=(j=a.attr("speed"))?j:1}h.push({type:f,id:c});d.append("<tr "+g+'><td><img src="'+k+'" /></td><td><input class="tracker-name" type="text" size="7" value="'+o+'"/></td></td><td><input class="tracker-path-numbers" type="text" size="7" value="'+
l+'"/></td><td><input class="tracker-zoom" type="text" size="2" value="'+i+'"/></td><td><input class="tracker-speed" type="text" size="1" value="'+j+'"/></td><td class="tracker-go"><img src="./img/tracker_go.png"/></td></tr>')}},n=function(){var b=$("#container");$.get("html/tracker.html").success(function(a){b.prepend(a);f=b.find("#tracker");g.publish("dizzy.ui.tracker.loaded",{tracker:f})}).error(function(){}).complete(function(){p();k()})},p=function(){var b=f.find("#tracker-expand");d=f.find("#tracker-list");
b.toggle(function(){d.show();g.publish("dizzy.presentation.transform.tracker.open")},function(){d.hide();g.publish("dizzy.presentation.transform.tracker.open")});f.bind("mousewheel",function(a){a.stopPropagation()});d.delegate(".tracker-go","click",function(){g.publish("dizzy.presentation.transform.tracker.go");var a=$(this).parent("tr").prop("rowIndex");e.visitGroup(h[a-1].id)});d.delegate(".tracker-name","change",function(){var a=$(this).parents("tr").prop("rowIndex"),a=e.groupList[a-1];$(this).val();
a.dom().attr("name",$(this).val())});d.delegate(".tracker-zoom","change",function(){var a=$(this).parents("tr").prop("rowIndex"),a=e.groupList[a-1],c=$(this).val();!isNaN(c)&&c<=100&&c>0?a.dom().attr("zoom",$(this).val()):$(this).val(a.dom().attr("zoom")?a.dom().attr("zoom"):"")});d.delegate(".tracker-speed","change",function(){var a=$(this).parents("tr").prop("rowIndex"),a=e.groupList[a-1],c=$(this).val();!isNaN(c)&&c<=10&&c>=0?a.dom().attr("speed",$(this).val()):$(this).val(a.dom().attr("speed")?
a.dom().attr("speed"):"1")});d.delegate(".tracker-path-numbers","change",function(){var a=$(this).parents("tr").prop("rowIndex"),a=e.groupList[a-1],c=$(this).val().split(/[ -.,;:+]/),b=a.dom().attr("class").match(/group_(\d+)/gi);if(b!=null)for(var d=0;d<b.length;d++)e.removePathNumber(a,parseInt(b[d].substring(6)));for(d=0;d<c.length;d++)c[d]!=""&&e.addPathNumber(a,c[d])});d.delegate("tr","hover",function(){var a=$(this).prop("rowIndex");a&&e.groupList[a-1].dom().children().toggleClass("hoveringElem")})};
return{init:function(){},destroy:function(){$("#tracker").remove()}}});